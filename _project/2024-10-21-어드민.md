---
layout: post
title: 어드민
date: 2024-10-21
category: project
categories:
  - project
  - 스푸키 타운
---
만화 정보를 직접 작성해서 올리는 게 낫겠다는 판단이 들자. 어드민 페이지를 하나 만들어야 겠다는 생각이 들었다. 만화 정보 뿐 아니라 직접 영화 정보도 올리고. 그러자 이미지를 업로드를 위해 CDN 서버를 이용해 볼까란 생각 까지 미쳤다. 그러니깐 흐름은 이렇다.

어드민 페이지에 접속해 만화나 또는 영화 정보를 올린다. 이때 영화 포스터나 만화책 표지 이미지등을 업로드하면CDN 서버로 저장한 후 아이디를 반환한 후 모든 정보가 올바르게 정립되면 데이터베이스에 저장한다.

interval을 사용해서 날먹하려고 했는데 후... 올바른 api key를 줘도 자꾸 인증 오류를 반환한다.. 얘는 나중에 고치고 다른 방식을 고민해봐야 겠다.

굳이 웹 접속을 고집할 필요는 없으니 그냥 도커에 올려서 접속하는 방식도 나쁘지 않아 보인다.  그러면 로그인 기능도 굳이 붙일 필요가 없고 단순하게 바로 만화 정보 업데이트 도구로 만들어야 겠다.


일단 adimin.js에 nest.js를 사용해 구축해보자.

간단한 만화 정보 업데이트의 플로우를 정리해 보자.

입력창에 제목, 그림 작가, 글작가, 출판일, 출판사, isbn10과 isbn13, 가격, 쪽수, 설명을 입력하고 책 표지 이미지를 업로드 한다. 출판일, 출판사, 가격, 쪽수, 설명은 입력하지 않아도 된다. 책 표지 역시 업로드하지 않아도 된다.

type 만화 정보 검증 명령
제목: 문자열
그림작가: 문자열
글작가: 문자열
출판일: Some(YYYY-mm-dd) | None
출판사: Some(문자열) | None
가격: Some | None
쪽수: Some | None
설명: Some| None
isbn13: 문자열
isbn10: 문자열
표지 이미지: Some | None

책 표지 이미지 형식은 png, gif, jpeg', webp, svg+xml로 제한한다. 이미지 차원 12000px를 넘으면 안 되고 이미지 영역 허용 크기는 100 메가 픽셀을 넘으면 안 된다. 최대 파일 사이즈는 10mb 을 넘으면 안 된다.

이를 위반하면 업로드는 실패해야 한다.

제목은 100자 이내로,  그림 작가와 글 작가는 20자 이내로, 출판일의 양식은 yyyy-mm-dd로 한다. 출판사는 20자 이내, isbn10과 isnbn13은 형식을 찾아 형식에 맞지 않으면 실패한다.  쪽수는 0이상 1000이하 여야 한다. 설명은 300 자로 한다.

검증은 성공하거나 실패한다. 

type 검증 성공
제목: 검증된 100자 이하의 문자열
그림작가: 검증된 20자 이하의 문자열
글작가: 검증된 20자 이하의 문자열
출판일 : 검증된(YYYY-mm-dd) | None
출판사: 검증된(20자 이내의 문자열) | None
가격: 검증된(0 이상의 정수) | None
쪽수: 검증된(0이상 1000이하의 수) | None
설명: 검증된(300자 이하의 문자열) | None
isbn13: 검증된 | None
isbn10: 검증된 | None
표지 이미지 : 검증된 | None


type 검증 실패
제목: 문자열
그림작가: 문자열
글작가: 문자열
출판일: Some(YYYY-mm-dd) | None
출판사: Some(문자열) | None
가격: Some | None
쪽수: Some | None
설명: Some| None
isbn13: 문자열
isbn10: 문자열
표지 이미지: Some | None
예외 메시지: 문자열

type: 이미지 업로드 명령
제목: 검증된 100자 이하의 문자열
그림작가: 검증된 20자 이하의 문자열
글작가: 검증된 20자 이하의 문자열
출판일 : 검증된(YYYY-mm-dd) | None
출판사: 검증된(20자 이내의 문자열) | None
가격: 검증된(0 이상의 정수) | None
쪽수: 검증된(0이상 1000이하의 수) | None
설명: 검증된(300자 이하의 문자열) | None
isbn13: 검증된 | None
isbn10: 검증된 | None
표지 이미지 : 검증된 | None


검증에 실패하면 검증 실패를 반환한다. 검증에 표지 이미지의 여부에 따라 흐름이 다르다. 검증된 표지 이미지로 이미지 업데이트 요청을 CDN 서버로 보내 성공한다면 경로를 받아온다. 그후에 다른 검증된 값과 함께 데이터베이스로 업데이트 요청을 보내는 흐름이 있다.

업로드할 표지 이미지가 있는 지 여부에 따라 흐름이 나뉜다. 있을 경우 이미지 업로드 명령을 업로드 서비스에 요청한다. 그후 성공했다면 만화 정보 업데이트 명령을 반환한다. 실패할 경우는 업로드 실패 명령을 반환한다. 재시작을 할 수 도 있지만 현재는 간단하게 업로드할 이미지가 없다고 간주하고 만화 정보 업데이트 명령을 반환한다.

업로드할 표지 이미지가 없을 경우 만화 정보 업데이트를 반환한다. 그러면 만화 정보 업데이트 명령은 무엇으로 이루어저야 하는가?

type 만화 정보 업데이트 명령
제목: 검증된 100자 이하의 문자열
그림작가: 검증된 20자 이하의 문자열
글작가: 검증된 20자 이하의 문자열
출판일 : 검증된(YYYY-mm-dd) | None
출판사: 검증된(20자 이내의 문자열) | None
가격: 검증된(0 이상의 정수) | None
쪽수: 검증된(0이상 1000이하의 수) | None
설명: 검증된(300자 이하의 문자열) | None
isbn13: 검증된 | None
isbn10: 검증된 | None
표지 이미지 url : 검증된 | None

그후 이 업데이트 명령을  데이터베이스에 접근할 수 있는 쪽으로 보낸다. 그후는 다시 만화 정보가 업데이트가 성공하거나 실패한다.

type 만화 정보 업데이트 성공
void

type 만화 정보 실패
제목: 검증된 100자 이하의 문자열
그림작가: 검증된 20자 이하의 문자열
글작가: 검증된 20자 이하의 문자열
출판일 : 검증된(YYYY-mm-dd) | None
출판사: 검증된(20자 이내의 문자열) | None
가격: 검증된(0 이상의 정수) | None
쪽수: 검증된(0이상 1000이하의 수) | None
설명: 검증된(300자 이하의 문자열) | None
isbn13: 검증된 | None
isbn10: 검증된 | None
표지 이미지 url : 검증된 | None
예외 메시지: 문자열

이 경우 조금 복잡하다. 이미 표지 이미지가 업데이트 된 후기 때문이다. 이를 자동으로 재시도 한 후 실패하면 다시 클라이언트로 보내는 게 제일 나아 보인다.

Bounded Context: 만화 정보 CRUD 어드민

워크플로: 
	만화 정보 create
트리거: 
	만화 정보 form이 제공됨 이벤트
핵심 입력: 
	만화 정보 form
다른 입력: 
	 표지 이미지 URL
출력 이벤트: 
	없음 
사이드 이펙트:
	없음 

만화 정보 data =
	제목 AND 그림작가 AND 글작가 AND isbn13 AND isbn 10  OR 출판일 OR 출판사 OR 가격 OR 쪽수 OR 설명

data 제목 = 1이상 100자 이하의 글자
data 그림 작가 = 1이상  20자 이하의 글자
data 글작가  = 1 이상 20자 이하의 글자
data isbn 13 =
	1. 접두 요소: 978 또는 979 (EAN 시스템과 일치)
	2. 그룹 식별자: 국가 또는 언어 그룹을 나타냄
	3. 발행자 식별자: 특정 출판사를 식별
	4. 서명 식별자: 특정 도서나 버전을 식별
	5. 체크 숫자: ISBN이 올바르게 구성되었는지 확인
	예: 978-0-306-40615-7
	
	- 978: 접두 요소
	- 0: 그룹 식별자
	- 306: 발행자 식별자
	- 40615: 서명 식별자
	- 7: 체크 숫자

data isbn 10 =
	1. 그룹 식별자: 국가 또는 언어 그룹을 나타냄
	2. 발행자 식별자: 특정 출판사를 식별
	3. 서명 식별자: 특정 도서나 버전을 식별
	4. 체크 숫자: ISBN이 올바르게 구성되었는지 확인
	
	예: 0-545-01022-5

	- 0: 그룹 식별자
	- 545: 발행자 식별자
	- 01022: 서명 식별자
	- 5: 체크 숫자

data 출판일 = 
	YYYY-mm-dd

data 출판사 =
	1자 이상 20자 이하 글자

data 가격 =
	 1 이상 1000 이하 숫자

data 쪽수 =
	1이상 1000 이하 숫자

data 설명 =
	10자 이상 300 자 이하 글자
data 표지 이미지
	* 이미지 형식은 png, gif, jpeg, webp, svg+xml로 제한한다. 
	* 이미지 차원 12000px를 넘으면 안 된다.
	* 이미지 영역 허용 크기는 100 메가 픽셀을 넘으면 안 된다. 
	* 최대 파일 사이즈는 10mb 을 넘으면 안 된다.


 검증되지 않은 만화 정보 폼 data = 
	검증되지 않은제목 AND 검증되지 않은 그림작가 AND  검증되지 않은 글작가 AND 검증되지 않은 isbn13 AND 검증되지 않은  isbn 10  OR 검증되지 않은 출판일 OR  검증되지 않은 출판사 OR 검증되지 않은 가격 OR 검증되지 않은 쪽수 OR 검증되지 않은 설명 OR 검증되지 않은 표지 이미지 

검증을 시도한 후 

검증된 만화 정보 폼 data  = 
	검증된 제목 AND 검증된  그림작가 AND  검증된 글작가 AND 검증된 isbn13 AND 검증된 isbn 10  OR 검증된출판일 OR  검증된출판사 OR 검증된가격 OR 검증된 쪽수 OR 검증된 설명 OR 검증된 표지 이미지

```
workflow 만화 정보 create = 
input: 만화 정보 form
outpot: 없음

//step1
do 만화 정보 form 검증
if 만화 정보가 검증 실패하면
만화 정보 검증 실패했다고 알려줌

//step2
do 만화 정보 업데이트 하기

return none (오류가 없을시)
```


```
sub step 만화 정보 form 검증 =
input: 검증되지 않은 만화 정보 폼 data
	제목 검증하기
	그림작가 검증하기
	글작가 검증하기
	isbn 13 형식 검증하기
	isbn 10 형식 검증하기
	만약 출판일이 존재하면 
		출판일 검증하기
	만약 출판사가 존재하면
		출판사 검증하기
	만약 가격이 존재하면
		가격 검증하기
	만약 쪽수가 존재하면
		쪽수 검증하기
	만약 설명이 존재하면 
		설명 검증하기
	만약 표지 이미지가 존재하면
		표지 이미지 검증하기

만약 모든 게 검증되면:
	return 검증된 만화 정보 Form
그렇지 않다면:
	return 검증 오류
```

```
sub step 만화 정보 업데이트 하기 =
dependencies 
input: 검증된 만화 정보 input

만약 검증된 만화 정보 input에서 표지 이미지가 존재하면
	do 이미지 서버로 업로드 하기
	만약 성공하면:
		업데이트 명령
	그렇지 않다면:
		업로드 오류
	do 업데이트 수행
		만약 성공하면:
			return 없음
		실패하면:
			return 업데이트 오류

```


- 구현 계획:

a) 도메인 타입 정의

커밋: "feat(horror-comic): 도메인 타입 정의"

b) 검증 함수 구현

커밋: "feat(horror-comic): 검증 함수 구현"

c) 업데이트 서비스 구현

커밋: "feat(horror-comic): 업데이트 서비스 구현"

d) 리포지토리 인터페이스 정의

커밋: "feat(horror-comic): 리포지토리 인터페이스 정의"

e) 이미지 업로드 서비스 구현

커밋: "feat(horror-comic): 이미지 업로드 서비스 구현"

f) AdminJS 리소스 구현

커밋: "feat(horror-comic): AdminJS 리소스 구현"

g) 컨트롤러 구현

커밋: "feat(horror-comic): 컨트롤러 구현"

h) 모듈 구성

커밋: "feat(horror-comic): 모듈 구성"